/* esm.sh - esbuild bundle(openai@4.67.2/lib/AbstractChatCompletionRunner) denonext production */
import{OpenAIError as y}from"/v135/openai@4.67.2/denonext/error.js";import{isRunnableFunctionWithParse as J}from"/v135/openai@4.67.2/denonext/lib/RunnableFunction.js";import{isAssistantMessage as F,isFunctionMessage as x,isToolMessage as L}from"/v135/openai@4.67.2/denonext/lib/chatCompletionUtils.js";import{EventStream as B}from"/v135/openai@4.67.2/denonext/lib/EventStream.js";import{isAutoParsableTool as G,parseChatCompletion as W}from"/v135/openai@4.67.2/denonext/lib/parser.js";var c=function(r,t,n,e){if(n==="a"&&!e)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?r!==t||!e:!t.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?e:n==="a"?e.call(r):e?e.value:t.get(r)},o,O,R,N,k,$,j,E,I=10,U=class extends B{constructor(){super(...arguments),o.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(t){this._chatCompletions.push(t),this._emit("chatCompletion",t);let n=t.choices[0]?.message;return n&&this._addMessage(n),t}_addMessage(t,n=!0){if("content"in t||(t.content=null),this.messages.push(t),n){if(this._emit("message",t),(x(t)||L(t))&&t.content)this._emit("functionCallResult",t.content);else if(F(t)&&t.function_call)this._emit("functionCall",t.function_call);else if(F(t)&&t.tool_calls)for(let e of t.tool_calls)e.type==="function"&&this._emit("functionCall",e.function)}}async finalChatCompletion(){await this.done();let t=this._chatCompletions[this._chatCompletions.length-1];if(!t)throw new y("stream ended without producing a ChatCompletion");return t}async finalContent(){return await this.done(),c(this,o,"m",O).call(this)}async finalMessage(){return await this.done(),c(this,o,"m",R).call(this)}async finalFunctionCall(){return await this.done(),c(this,o,"m",N).call(this)}async finalFunctionCallResult(){return await this.done(),c(this,o,"m",k).call(this)}async totalUsage(){return await this.done(),c(this,o,"m",$).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let t=this._chatCompletions[this._chatCompletions.length-1];t&&this._emit("finalChatCompletion",t);let n=c(this,o,"m",R).call(this);n&&this._emit("finalMessage",n);let e=c(this,o,"m",O).call(this);e&&this._emit("finalContent",e);let i=c(this,o,"m",N).call(this);i&&this._emit("finalFunctionCall",i);let a=c(this,o,"m",k).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(A=>A.usage)&&this._emit("totalUsage",c(this,o,"m",$).call(this))}async _createChatCompletion(t,n,e){let i=e?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),c(this,o,"m",j).call(this,n);let a=await t.chat.completions.create({...n,stream:!1},{...e,signal:this.controller.signal});return this._connected(),this._addChatCompletion(W(a,n))}async _runChatCompletion(t,n,e){for(let i of n.messages)this._addMessage(i,!1);return await this._createChatCompletion(t,n,e)}async _runFunctions(t,n,e){let i="function",{function_call:a="auto",stream:A,...v}=n,f=typeof a!="string"&&a?.name,{maxChatCompletions:T=I}=e||{},w={};for(let l of n.functions)w[l.name||l.function.name]=l;let g=n.functions.map(l=>({name:l.name||l.function.name,parameters:l.parameters,description:l.description}));for(let l of n.messages)this._addMessage(l,!1);for(let l=0;l<T;++l){let b=(await this._createChatCompletion(t,{...v,function_call:a,functions:g,messages:[...this.messages]},e)).choices[0]?.message;if(!b)throw new y("missing message in ChatCompletion response");if(!b.function_call)return;let{name:u,arguments:C}=b.function_call,m=w[u];if(m){if(f&&f!==u){let h=`Invalid function_call: ${JSON.stringify(u)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:i,name:u,content:h});continue}}else{let h=`Invalid function_call: ${JSON.stringify(u)}. Available options are: ${g.map(P=>JSON.stringify(P.name)).join(", ")}. Please try again`;this._addMessage({role:i,name:u,content:h});continue}let _;try{_=J(m)?await m.parse(C):C}catch(h){this._addMessage({role:i,name:u,content:h instanceof Error?h.message:String(h)});continue}let M=await m.function(_,this),d=c(this,o,"m",E).call(this,M);if(this._addMessage({role:i,name:u,content:d}),f)return}}async _runTools(t,n,e){let i="tool",{tool_choice:a="auto",stream:A,...v}=n,f=typeof a!="string"&&a?.function?.name,{maxChatCompletions:T=I}=e||{},w=n.tools.map(s=>{if(G(s)){if(!s.$callback)throw new y("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:s.$callback,name:s.function.name,description:s.function.description||"",parameters:s.function.parameters,parse:s.$parseRaw,strict:!0}}}return s}),g={};for(let s of w)s.type==="function"&&(g[s.function.name||s.function.function.name]=s.function);let l="tools"in n?w.map(s=>s.type==="function"?{type:"function",function:{name:s.function.name||s.function.function.name,parameters:s.function.parameters,description:s.function.description,strict:s.function.strict}}:s):void 0;for(let s of n.messages)this._addMessage(s,!1);for(let s=0;s<T;++s){let u=(await this._createChatCompletion(t,{...v,tool_choice:a,tools:l,messages:[...this.messages]},e)).choices[0]?.message;if(!u)throw new y("missing message in ChatCompletion response");if(!u.tool_calls?.length)return;for(let C of u.tool_calls){if(C.type!=="function")continue;let m=C.id,{name:_,arguments:M}=C.function,d=g[_];if(d){if(f&&f!==_){let p=`Invalid tool_call: ${JSON.stringify(_)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:i,tool_call_id:m,content:p});continue}}else{let p=`Invalid tool_call: ${JSON.stringify(_)}. Available options are: ${Object.keys(g).map(S=>JSON.stringify(S)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:m,content:p});continue}let h;try{h=J(d)?await d.parse(M):M}catch(p){let S=p instanceof Error?p.message:String(p);this._addMessage({role:i,tool_call_id:m,content:S});continue}let P=await d.function(h,this),q=c(this,o,"m",E).call(this,P);if(this._addMessage({role:i,tool_call_id:m,content:q}),f)return}}}};o=new WeakSet,O=function(){return c(this,o,"m",R).call(this).content??null},R=function(){let t=this.messages.length;for(;t-- >0;){let n=this.messages[t];if(F(n)){let{function_call:e,...i}=n,a={...i,content:n.content??null,refusal:n.refusal??null};return e&&(a.function_call=e),a}}throw new y("stream ended without producing a ChatCompletionMessage with role=assistant")},N=function(){for(let t=this.messages.length-1;t>=0;t--){let n=this.messages[t];if(F(n)&&n?.function_call)return n.function_call;if(F(n)&&n?.tool_calls?.length)return n.tool_calls.at(-1)?.function}},k=function(){for(let t=this.messages.length-1;t>=0;t--){let n=this.messages[t];if(x(n)&&n.content!=null||L(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(e=>e.role==="assistant"&&e.tool_calls?.some(i=>i.type==="function"&&i.id===n.tool_call_id)))return n.content}},$=function(){let t={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:n}of this._chatCompletions)n&&(t.completion_tokens+=n.completion_tokens,t.prompt_tokens+=n.prompt_tokens,t.total_tokens+=n.total_tokens);return t},j=function(t){if(t.n!=null&&t.n>1)throw new y("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},E=function(t){return typeof t=="string"?t:t===void 0?"undefined":JSON.stringify(t)};export{U as AbstractChatCompletionRunner};
//# sourceMappingURL=AbstractChatCompletionRunner.js.map